@model MCR.Theme.ViewComponents.ContactFormWidgetViewModel

@{
    var isHeroForm = Model.CssClass?.Contains("hero") == true;
    var formClass = isHeroForm ? "mcr-hero-form" : "mcr-contact-form";
    var formId = "contact-form-" + Guid.NewGuid().ToString("N").Substring(0, 8);
}

<div class="@(isHeroForm ? Model.CssClass : "contact-form-widget")">
    @if (!string.IsNullOrEmpty(Model.FormTitle))
    {
        <h3 class="form-title">@Model.FormTitle</h3>
    }
    @if (!string.IsNullOrEmpty(Model.FormSubtitle))
    {
        <p class="form-subtitle">@Model.FormSubtitle</p>
    }

    <form id="@formId"
          method="post"
          action="@Model.WorkflowUrl"
          class="@formClass">
        @Html.AntiForgeryToken()

        <input type="hidden" name="recipientEmail" value="@Model.RecipientEmail" />

        @if (isHeroForm)
        {
            @* Compact hero form layout *@
            <div class="row g-1">
                <div class="col-6">
                    <div class="form-group">
                        <label for="name-@formId" class="form-label">Name <span class="required">*</span></label>
                        <input type="text" class="form-control" id="name-@formId" name="name" required
                               placeholder="Your name" autocomplete="name" />
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        <label for="email-@formId" class="form-label">Email <span class="required">*</span></label>
                        <input type="email" class="form-control" id="email-@formId" name="email" required
                               placeholder="Email" autocomplete="email" />
                    </div>
                </div>
            </div>

            <div class="row g-1">
                <div class="col-6">
                    <div class="form-group">
                        <label for="phone-@formId" class="form-label">Phone <span class="required">*</span></label>
                        <input type="tel" class="form-control" id="phone-@formId" name="phone" required
                               placeholder="Phone" autocomplete="tel" />
                    </div>
                </div>
                @if (Model.ShowDepartment)
                {
                    <div class="col-6">
                        <div class="form-group">
                            <label for="dept-@formId" class="form-label">Department</label>
                            <select class="form-select" id="dept-@formId" name="department">
                                <option value="">Select</option>
                                <option value="Immigration">Immigration</option>
                                <option value="Family">Family</option>
                                <option value="Injury">Injury</option>
                            </select>
                        </div>
                    </div>
                }
            </div>

            <div class="form-group">
                <label for="msg-@formId" class="form-label">Message <span class="required">*</span></label>
                <textarea class="form-control" id="msg-@formId" name="message" rows="2" required
                          placeholder="Your enquiry..."></textarea>
            </div>

            <div class="form-group recaptcha-group">
                @await DisplayAsync(await New.ReCaptcha())
            </div>

            <button type="submit" class="btn btn-hero-submit">
                <span class="btn-text">@Model.SubmitButtonText</span>
                <span class="btn-loading" style="display:none;">
                    <i class="fas fa-spinner fa-spin"></i> Sending...
                </span>
            </button>

            <div class="form-messages">
                <div class="alert alert-success" style="display:none;" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <span class="message-text"></span>
                </div>
                <div class="alert alert-danger" style="display:none;" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span class="message-text"></span>
                </div>
            </div>
        }
        else
        {
            @* Full contact page form layout *@
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="name-@formId" class="form-label">Full Name <span class="required">*</span></label>
                        <input type="text" class="form-control" id="name-@formId" name="name" required
                               placeholder="Enter your full name" autocomplete="name" />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="email-@formId" class="form-label">Email Address <span class="required">*</span></label>
                        <input type="email" class="form-control" id="email-@formId" name="email" required
                               placeholder="Enter your email address" autocomplete="email" />
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="phone-@formId" class="form-label">Phone Number <span class="required">*</span></label>
                        <input type="tel" class="form-control" id="phone-@formId" name="phone" required
                               placeholder="Enter your phone number" autocomplete="tel" />
                    </div>
                </div>
                @if (Model.ShowDepartment)
                {
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="dept-@formId" class="form-label">
                                Department
                                @if (Model.DepartmentRequired)
                                {
                                    <span class="required">*</span>
                                }
                            </label>
                            <select class="form-select" id="dept-@formId" name="department"
                                    @(Model.DepartmentRequired ? "required" : "")>
                                <option disabled selected value="">Select Department</option>
                                <option value="Immigration">Immigration &amp; Visas</option>
                                <option value="Family">Family Law</option>
                                <option value="Injury">Personal Injury</option>
                                <option value="Other">Other Enquiry</option>
                            </select>
                        </div>
                    </div>
                }
            </div>

            <div class="form-group">
                <label for="msg-@formId" class="form-label">Message <span class="required">*</span></label>
                <textarea class="form-control" id="msg-@formId" name="message" rows="5" required
                          placeholder="How can we help you?"></textarea>
            </div>

            <div class="form-group recaptcha-container">
                @await DisplayAsync(await New.ReCaptcha())
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-cta btn-submit">
                    <span class="btn-text">@Model.SubmitButtonText</span>
                    <span class="btn-loading" style="display:none;">
                        <i class="fas fa-spinner fa-spin"></i> Sending...
                    </span>
                </button>
            </div>

            <div class="form-messages">
                <div class="alert alert-success" style="display:none;" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <span class="message-text"></span>
                </div>
                <div class="alert alert-danger" style="display:none;" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span class="message-text"></span>
                </div>
            </div>
        }
    </form>
</div>

<script>
(function() {
    // Find all contact forms on the page (both regular and hero forms)
    document.querySelectorAll('.mcr-contact-form, .mcr-hero-form').forEach(function(form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const btnText = form.querySelector('.btn-text');
            const btnLoading = form.querySelector('.btn-loading');
            const submitBtn = form.querySelector('button[type="submit"]');
            const successAlert = form.querySelector('.alert-success');
            const errorAlert = form.querySelector('.alert-danger');
            const successMsg = successAlert.querySelector('.message-text');
            const errorMsg = errorAlert.querySelector('.message-text');

            // Show loading state
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            submitBtn.disabled = true;
            successAlert.style.display = 'none';
            errorAlert.style.display = 'none';

            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    successMsg.textContent = '@Html.Raw(Model.SuccessMessage.Replace("'", "\\'"))';
                    successAlert.style.display = 'flex';
                    form.reset();

                    // Scroll to success message
                    successAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    throw new Error('Form submission failed');
                }
            } catch (error) {
                errorMsg.textContent = 'Sorry, there was an error sending your message. Please try again or call us directly.';
                errorAlert.style.display = 'flex';
            } finally {
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
    });
})();
</script>
