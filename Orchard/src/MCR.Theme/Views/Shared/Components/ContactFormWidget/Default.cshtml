@model MCR.Theme.ViewComponents.ContactFormWidgetViewModel

<div class="contact-form-widget @Model.CssClass">
    @if (!string.IsNullOrEmpty(Model.FormTitle))
    {
        <h3 class="form-title">@Model.FormTitle</h3>
    }
    @if (!string.IsNullOrEmpty(Model.FormSubtitle))
    {
        <p class="form-subtitle">@Model.FormSubtitle</p>
    }

    <form id="contact-form-@Guid.NewGuid().ToString("N").Substring(0, 8)"
          method="post"
          action="@Model.WorkflowUrl"
          class="mcr-contact-form">
        @Html.AntiForgeryToken()

        <input type="hidden" name="recipientEmail" value="@Model.RecipientEmail" />

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="name" class="form-label">Full Name <span class="required">*</span></label>
                    <input type="text" class="form-control" id="name" name="name" required
                           placeholder="Enter your full name" autocomplete="name" />
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="email" class="form-label">Email Address <span class="required">*</span></label>
                    <input type="email" class="form-control" id="email" name="email" required
                           placeholder="Enter your email address" autocomplete="email" />
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="phone" class="form-label">Phone Number <span class="required">*</span></label>
                    <input type="tel" class="form-control" id="phone" name="phone" required
                           placeholder="Enter your phone number" autocomplete="tel" />
                </div>
            </div>
            @if (Model.ShowDepartment)
            {
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="department" class="form-label">
                            Department
                            @if (Model.DepartmentRequired)
                            {
                                <span class="required">*</span>
                            }
                        </label>
                        <select class="form-select" id="department" name="department"
                                @(Model.DepartmentRequired ? "required" : "")>
                            <option disabled selected value="">Select Department</option>
                            <option value="Visas">Visas &amp; Immigration</option>
                            <option value="Divorce">Divorce &amp; Family Law</option>
                            <option value="Personal">Personal Injury</option>
                            <option value="Litigation">Litigation &amp; Disputes</option>
                            <option value="Debt">Debt &amp; Insolvency</option>
                        </select>
                    </div>
                </div>
            }
        </div>

        <div class="form-group">
            <label for="message" class="form-label">Message <span class="required">*</span></label>
            <textarea class="form-control" id="message" name="message" rows="5" required
                      placeholder="How can we help you?"></textarea>
        </div>

        <div class="form-group recaptcha-container">
            @await DisplayAsync(await New.ReCaptcha())
        </div>

        <div class="form-group">
            <button type="submit" class="btn btn-cta">
                <span class="btn-text">@Model.SubmitButtonText</span>
                <span class="btn-loading" style="display:none;">
                    <i class="fas fa-spinner fa-spin"></i> Sending...
                </span>
            </button>
        </div>

        <div class="form-messages">
            <div class="alert alert-success" style="display:none;" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <span class="message-text"></span>
            </div>
            <div class="alert alert-danger" style="display:none;" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span class="message-text"></span>
            </div>
        </div>
    </form>
</div>

<script>
(function() {
    // Find all contact forms on the page
    document.querySelectorAll('.mcr-contact-form').forEach(function(form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const btnText = form.querySelector('.btn-text');
            const btnLoading = form.querySelector('.btn-loading');
            const submitBtn = form.querySelector('button[type="submit"]');
            const successAlert = form.querySelector('.alert-success');
            const errorAlert = form.querySelector('.alert-danger');
            const successMsg = successAlert.querySelector('.message-text');
            const errorMsg = errorAlert.querySelector('.message-text');

            // Show loading state
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            submitBtn.disabled = true;
            successAlert.style.display = 'none';
            errorAlert.style.display = 'none';

            try {
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    successMsg.textContent = '@Html.Raw(Model.SuccessMessage.Replace("'", "\\'"))';
                    successAlert.style.display = 'flex';
                    form.reset();

                    // Scroll to success message
                    successAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    throw new Error('Form submission failed');
                }
            } catch (error) {
                errorMsg.textContent = 'Sorry, there was an error sending your message. Please try again or call us directly.';
                errorAlert.style.display = 'flex';
            } finally {
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
    });
})();
</script>
